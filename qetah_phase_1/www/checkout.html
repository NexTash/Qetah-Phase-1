{% extends "templates/primary.html" %}

{% block title %} QETAH | Checkout {% endblock %}

{% block content %}
<style>
  .visa {
    font-family: 'Verdana', 'Arial', sans-serif;
    /* Use system fonts that resemble Visa */
    font-weight: bold;
    /* Bold style similar to Visa */
    color: #1a1f71;
    /* Visa's signature blue color */
    font-size: 50px;
    /* Adjust size as needed */
    letter-spacing: 2px;
    /* Adds spacing similar to the Visa logo */
    text-transform: uppercase;
    /* Visa text is usually in uppercase */
  }

  .stripe {
    font-family: 'Poppins', sans-serif;
    font-weight: bold;
    font-size: 2rem;
    color: #6772E5;
    letter-spacing: -0.02em;
    text-transform: lowercase;
  }

  .stripe-card.focus {
    border: 2px solid #6772e5;
    background-color: #c1c6ff69;

  }

  .stripe-card {
    .focus {
      border: 2px solid #6772e5;
      background-color: #c1c6ff69;

    }
  }

  .stripe-card .card {
    display: flex;
    justify-content: space-between;
    flex-direction: row;
    outline: none;
  }

  .stripe-card .card .card-head {
    display: flex;
    align-items: center;
  }

  .stripe-card .card .card-head .check input {
    top: -5px;
  }

  .stripe-card .card .card-head .check input:before {
    border-radius: 50px;

  }

  .stripe-card .card .card-body .stripe-logo {
    border-radius: 0.5rem;
  }
</style>

<!-- <h1>Your Cart</h1> -->
<!-- <div class="cart-container">
          </div> -->

<div class="content-area" :class="{'shifted-content': isStatic}">
  <div class="container checkout">
    <form action="" method="" class="information" id="informationForm">
      <h5>Delivery Information</h5>
      <!-- Target div where the data will be displayed -->
      <div id="displayData"></div>
      <!-- <div class="badge badge-secondary m-2">Office</div>
      <div class="grp">
        <h6 class="title">Full Name :</h6>
        <div class="subtitle">${data.firstname} ${data.lastname}</div>
      </div>
      <div class="grp">
        <h6 class="title">Phone No :</h6>
        <div class="subtitle">+92 3164241634</div>
      </div>
      <div class="grp">
        <h6 class="address">Address :</h6>
        <div class="subtitle">Lorem, ipsum dolor sit amet consectetur adipisicing elit. Explicabo esse ad sit cum
          praesentium labore deleniti ea aliquam nulla, hic illo est nobis numquam accusantium, ex laboriosam aliquid
          cupiditate ducimus.</div>
      </div>
      <div class="grp">
        <h6 class="title">E-mail :</h6>
        <p class="subtitle">ammarpubgplayer97@gmail.com</p>
      </div>
      <div class="grp">
        <h6 class="title">Province :</h6>
        <div class="subtitle">Punjab</div>
      </div>
      <div class="grp">
        <h6 class="title">City :</h6>
        <div class="subtitle">Lahore</div>
      </div>
      <div class="grp">
        <h6 class="title">Zip / Postal Code :</h6>
        <div class="subtitle">54810</div>
      </div> -->
      <div
        style="margin: 0px;border: none;width: 100%;color: black;padding: 0;background: rgb(207, 207, 207);height: 1px;">
      </div>
      <h5 class="card-title mt-3">Card Payment</h5>
      <div class="stripe-card">
        <div class="card inner-card focus" tabindex="0" data-radio-id="radio1">
          <div class="card-head">
            <label class="check check-disable"> <input type="checkbox" checked="checked" disabled id="radio1" /></label>
            <div class="stripe">Stripe</div>
          </div>
          <div class="card-body">
            <img class="stripe-logo" src="/assets/qetah_phase_1/images/stripe.svg" height="50px" width="50px">
          </div>
        </div>
      </div>
    </form>

    <form action="" method="" class="payment" id="paymentForm">
      <h5>Promotion</h5>
      <div class="grp">
        <div class="form-field">
          <div class="field field-dark">
            <input type="text" class="field-text" placeholder="Enter Code" id="code" name="code" />
          </div>
        </div>
        <button type="button" class="btn btn-secondary btn-apply" onclick="on_chek()">Apply</button>
      </div>
      <h5>Order Summary</h5>
      <div class="order-info">
        <div class="order-detail">
          <div class="item">Total (<span id="item-count">0</span> items)</div> <!-- Item count goes here -->
          <div class="">$ <span id="subtotal">0</span></div> <!-- Subtotal goes here -->
        </div>
        <div class="order-detail">
          <div class="item">Delivery Fee</div>
          <div class="price" id="delivery-fee">USD. 0.00</div>
        </div>
        <div class="order-detail">
          <div class="item">Delivery Discount</div>
          <div class="price" id="delivery-discount">USD. 0.00</div>
        </div>
        <hr>
        <div class="total">
          <div class="sum">Total:</div>
          <div class="price" id="grand-total">USD. 0.00</div>
        </div>
        <!-- <p>Subtotal: Rs. <span id="subtotal">0.00</span></p>
        <p>Grand Total (including delivery): Rs. <span id="grand-total">0.00</span></p>
        <p>Items in Cart: <span id="item-count">0</span></p>
        <p id="messages"></p>

        <input type="text" id="code" placeholder="Enter Promo Code">
        <button id="apply-code">Apply Promo Code</button> -->

        <div class="taxes">Taxes included, where applicable</div>
        <button class="btn btn-dark btn-block" onclick="on_proceed()">Proceed to Pay</button>
      </div>
    </form>
    <div id="messages"></div>

  </div>


  <div class="container checkout-items">
    <!-- Cart items will be dynamically added here by JavaScript -->
  </div>
  <div class="container wishlist-items">
    <!-- Wishlist items will be dynamically added here by JavaScript -->
  </div>
  <script>
    // Function to display data from localStorage
    function displayData() {
      const data = JSON.parse(localStorage.getItem('shippingDetails'));

      // Log the retrieved data to the console
      console.log('Retrieved data from localStorage:', data);

      if (data) {
        const displayDiv = document.getElementById('displayData');
        displayDiv.innerHTML = `
        <div class="badge badge-secondary m-2">Office</div>
        <div class="grp">
        <h6 class="title">Full Name :</h6>
        <div class="subtitle">${data.firstname} , ${data.lastname}</div>
        </div>
        <div class="grp">
        <h6 class="title">Phone No :</h6>
        <div class="subtitle">${data.phone}</div>
        </div>
        <div class="grp">
        <h6 class="address">Address :</h6>
        <div class="subtitle">${data.address}.</div>
        </div>
        <div class="grp">
        <h6 class="title">E-mail :</h6>
        <p class="subtitle">${data.email}</p>
        </div>
        <div class="grp">
        <h6 class="title">State :</h6>
        <div class="subtitle">${data.state}</div>
        </div>
        <div class="grp">
        <h6 class="title">City :</h6>
        <div class="subtitle">${data.city}</div>
        </div>
        <div class="grp">
        <h6 class="title">Zip / Postal Code :</h6>
        <div class="subtitle">${data.postalcode}</div>
        </div>
      `;

        // Also fill the form fields with the data from localStorage
        document.getElementById("fullname").value = `${data.firstname} ${data.lastname}`;
        document.getElementById("state").value = data.state;
        document.getElementById("city").value = data.city;
        document.getElementById("phone").value = data.phone;
        document.getElementById("address").value = data.address;
        document.getElementById("code").value = data.postalcode;
      } else {
        console.log('No data found in localStorage');
      }
    }
    document.addEventListener('DOMContentLoaded', function () {
      displayData();
    });
  </script>

  <script>
    function on_proceed() {
      let fullname = document.getElementById("fullname").value;
      let province = document.getElementById("state").value;
      let city = document.getElementById("city").value;
      let phone = document.getElementById("phone").value;
      let address = document.getElementById("address").value;
      let code = document.getElementById("code").value;

      frappe.call({
        method: 'qetah_phase_1.events.proceed_checkout.checks',
        args: {
          fullname: fullname,
          phone: phone,
          address: address,
          city: city,
          province: province,
          code: code,
        },
        callback(r) {
          console.log(r.message);
          document.getElementById("messages").innerHTML = r.message;

          // Clear the form fields after submission
          document.getElementById("fullname").value = "";
          document.getElementById("phone").value = "";
          document.getElementById("address").value = "";
          document.getElementById("city").value = "";
          document.getElementById("state").value = "";
          document.getElementById("code").value = "";
        }
      });
      localStorage.removeItem('cart')
      window.location.reload();
    }
  </script>

  <!-- stripe-card -->
  <script>
    // Get all the card and radio input elements
    const cards = document.querySelectorAll('.inner-card');
    const radios = document.querySelectorAll('input[type="checkbox"]');

    // Add event listener to each card
    cards.forEach(card => {
      card.addEventListener('click', function () {
        // Remove focus and checked attributes from all cards and radios
        cards.forEach(c => c.classList.remove('focus'));
        radios.forEach(r => r.removeAttribute('checked'));

        // Add focus class to the clicked card
        this.classList.add('focus');

        // Get the associated radio input using the data attribute
        const radioId = this.getAttribute('data-radio-id');
        const radio = document.getElementById(radioId);

        // Set the checked attribute on the associated radio input
        if (radio) {
          radio.setAttribute('checked', 'checked');
        }
      });
    });


  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const cartContainer = document.querySelector('.checkout-items');
      let cartItems = JSON.parse(localStorage.getItem('cart')) || [];

      // Define delivery fee and discount
      const deliveryFee = 1000; // Example delivery fee
      const deliveryDiscount = 125; // Example delivery discount

      // Function to calculate and update the grand total
      function calculateGrandTotal(subtotal) {
        const totalWithFee = subtotal + deliveryFee; // Add delivery fee
        const totalWithDiscount = totalWithFee - deliveryDiscount; // Subtract discount
        return totalWithDiscount; // Return the final grand total
      }

      // Render Cart Items and Update Subtotal
      function renderCartItems(items) {
        cartContainer.innerHTML = ''; // Clear the container before appending new items
        let subtotal = 0;
        let itemCount = items.length;

        items.forEach((item, index) => {
          const price = parseFloat(item.price.replace(/[^0-9.-]/g, '')); // Convert price string to a number
          subtotal += price;
          const itemHTML = `
                <div class="card card-webinar cart-product-card">
                    <div class="card-head">
                        <span>Package ${index + 1} of ${items.length}</span>
                        <p>Fulfilled by <b>QETAH</b></p>
                    </div>
                    <hr />
                    <div class="cart-card">
                        <div class="card-head">
                            <div class="cart-conent">
                                <img src="${item.image}" alt="${item.title}" class="image" />
                                <div class="card-desc">
                                    <p class="text-ellipsis text-ellipsis-2">${item.desc}</p>
                                    
                                   ${item.brand ? `<span>${item.brand}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="prices">
                                <p class="price"> ${item.price}</p>
                                ${item.discount ? `<span>${item.discount}</span>` : ''}
                                <div class="icon-group">
                                    <span class="wishlist delete-item" data-title="${item.title}">
                                    <i class="bx bx-trash"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-foot">
                            <div class="qty">
                                <span>Qty:</span>
                                <span>1</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
          cartContainer.innerHTML += itemHTML; // Append the item to the cart container
        });

        // Update the subtotal and item count
        document.getElementById('subtotal').textContent = subtotal.toFixed(2); // Display subtotal
        document.getElementById('item-count').textContent = itemCount; // Display item count

        // Calculate and display the grand total
        const grandTotal = calculateGrandTotal(subtotal);
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2); // Display grand total

        // Update delivery fee and discount
        document.getElementById('delivery-fee').textContent = deliveryFee.toFixed(2);
        document.getElementById('delivery-discount').textContent = deliveryDiscount.toFixed(2);

        // Add event listeners to all delete buttons (trash icons)
        document.querySelectorAll('.delete-item').forEach((trashIcon, index) => {
          trashIcon.addEventListener('click', function () {
            deleteCartItem(index);  // Use index from forEach to delete item
          });
        });
      }

      // Function to delete an item from the cart
      function deleteCartItem(index) {
        cartItems.splice(index, 1); // Remove item from array using index
        localStorage.setItem('cart', JSON.stringify(cartItems)); // Save the updated cart to localStorage
        renderCartItems(cartItems); // Re-render the updated cart
      }

      // Call renderCartItems on page load
      renderCartItems(cartItems);

      // Promo code logic
      document.getElementById('apply-code').addEventListener('click', function () {
        const promoCode = document.getElementById('code').value;
        let subtotal = parseFloat(document.getElementById('subtotal').textContent);

        if (isNaN(subtotal)) {
          document.getElementById('messages').textContent = "Subtotal is invalid!";
          return;
        }

        if (promoCode === 'DISCOUNT10') {
          const discount = subtotal * 0.10;
          const newSubtotal = subtotal - discount;
          document.getElementById('subtotal').textContent = newSubtotal.toFixed(2);
          localStorage.setItem('subtotal', newSubtotal.toFixed(2));
          document.getElementById('messages').textContent = `Promo code applied! You saved Rs. ${discount.toFixed(2)}.`;

          // Update the grand total after applying the promo code
          const grandTotal = calculateGrandTotal(newSubtotal);
          document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        } else {
          document.getElementById('messages').textContent = "Invalid promo code.";
        }
      });

      // Retrieve subtotal and item count from localStorage on page load
      const storedSubtotal = localStorage.getItem('subtotal') || '0.00';
      const itemCount = (JSON.parse(localStorage.getItem('cart')) || []).length;
      document.getElementById('subtotal').textContent = storedSubtotal;
      document.getElementById('item-count').textContent = itemCount;

      // Recalculate the grand total after page load
      const grandTotal = calculateGrandTotal(parseFloat(storedSubtotal));
      document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
    });

  </script>

  {% endblock %}