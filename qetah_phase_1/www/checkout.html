{% extends "templates/primary.html" %}

{% block title %} QETAH | Checkout {% endblock %}

{% block content %}
<style>
  .visa {
    font-family: 'Verdana', 'Arial', sans-serif;
    /* Use system fonts that resemble Visa */
    font-weight: bold;
    /* Bold style similar to Visa */
    color: #1a1f71;
    /* Visa's signature blue color */
    font-size: 50px;
    /* Adjust size as needed */
    letter-spacing: 2px;
    /* Adds spacing similar to the Visa logo */
    text-transform: uppercase;
    /* Visa text is usually in uppercase */
  }

  .stripe {
    font-family: 'Poppins', sans-serif;
    font-weight: bold;
    font-size: 2rem;
    color: #6772E5;
    letter-spacing: -0.02em;
    text-transform: lowercase;
  }

  .COD {
    font-family: 'Poppins', sans-serif;
    font-weight: bold;
    font-size: 1.5rem;
    color: #000000;
    letter-spacing: -0.02em;
  }

  .stripe-card.focus {
    border: 2px solid #6772e5;
    background-color: #c1c6ff69;

  }

  .stripe-card {
    .focus {
      border: 2px solid #6772e5;
      background-color: #c1c6ff69;

    }
  }

  .stripe-card .card {
    display: flex;
    justify-content: space-between;
    flex-direction: row;
    outline: none;
  }

  .stripe-card .card .card-head {
    display: flex;
    align-items: center;
  }

  .stripe-card .card .card-head .check input {
    top: -5px;
  }

  .stripe-card .card .card-head .check input:before {
    border-radius: 50px;

  }

  .stripe-card .card .card-body .stripe-logo {
    border-radius: 0.5rem;
  }
</style>

<!-- <h1>Your Cart</h1> -->
<!-- <div class="cart-container">
          </div> -->

<div class="content-area" :class="{'shifted-content': isStatic}">
  <div class="container checkout">
    <form action="" method="POST" class="information" id="informationForm">
      <h5>Delivery Information</h5>
      <!-- Target div where the data will be displayed -->
      <div id="displayData"></div>
      <div
        style="margin: 0px;border: none;width: 100%;color: black;padding: 0;background: rgb(207, 207, 207);height: 1px;">
      </div>
      <h5 class="card-title mt-3">Card Payment</h5>
      <div class="stripe-card">
        <div class="card inner-card " tabindex="0" data-radio-id="stripe">
          <div class="card-head">
            <label class="check check-disable"> <input type="radio" id="stripe" name="pm" checked=""/></label>
            <div class="stripe" id="stripe">Stripe</div>
          </div>
          <div class="card-body">
            <img class="stripe-logo" src="/assets/qetah_phase_1/images/stripe.svg" height="50px" width="50px">
          </div>
        </div>
        <div class="card inner-card " tabindex="0" data-radio-id="cod">
          <div class="card-head">
            <label class="check check-disable"> <input type="radio" id="cod"  name="pm"  checked=""/></label>
            <div class="COD">Cash on Delivery</div>
          </div>
        </div>
      </div>
    </form>

    <form action="" method="" class="payment" id="paymentForm">
      <h5>Promotion</h5>
      <div class="grp">
        <div class="form-field">
          <div class="field field-dark">
            <input type="text" class="field-text" placeholder="Enter Code" id="code" name="code" />
          </div>
        </div>
        <button type="button" class="btn btn-secondary btn-apply" onclick="on_chek()">Apply</button>
      </div>
      <h5>Order Summary</h5>
      <div class="order-info">
        <div class="order-detail">
          <div class="item">Total (<span id="item-count" ></span> items)</div>
           <!-- Item count goes here -->
          <div class="">$ <span id="subtotal">0</span></div> <!-- Subtotal goes here -->
        </div>
        <div class="order-detail">
          <div class="item">Delivery Fee</div>
          <div class="price" id="delivery-fee">USD. 0.00</div>
        </div>
        <div class="order-detail">
          <div class="item">Delivery Discount</div>
          <div class="price" id="delivery-discount">USD. 0.00</div>
        </div>
        <hr>
        <div class="total">
          <div class="sum">Total:</div>
          <div class="price" id="grand-total" ></div>
        </div>
        <!-- <p>Subtotal: Rs. <span id="subtotal">0.00</span></p>
        <p>Grand Total (including delivery): Rs. <span id="grand-total">0.00</span></p>
        <p>Items in Cart: <span id="item-count">0</span></p>
        <p id="messages"></p>

        <input type="text" id="code" placeholder="Enter Promo Code">
        <button id="apply-code">Apply Promo Code</button> -->

        <div class="taxes">Taxes included, where applicable</div>
        <input type="button" class="btn btn-dark btn-block" data-field="proceed-checkout" onclick="on_proceed()" value="Proceed to Pay"></input>
      </div>
    </form>

  </div>


  <div class="container checkout-items">
    <!-- Cart items will be dynamically added here by JavaScript -->
  </div>
  <div class="container wishlist-items">
    <!-- Wishlist items will be dynamically added here by JavaScript -->
  </div>

<script>
function on_proceed() {
  console.log("working");
  
  // Retrieve form input values
  let fullname = "";
  let state = "";
  let city = "";
  let phone = "";
  let address = "";
  let code = "";
  let email = "";
  let stripe = 0;
  let cod = 0;
  // let cod = document.getElementById("cod").value;
  let item_count1 = 0;
  let grand_total1 = "";
  let title = " shoes";

  console.log("variables created");

  fullname = document.getElementById("fullname").value;
  console.log(fullname);
  state = document.getElementById("state").value;
  console.log(state);
  
  city = document.getElementById("city").value;
  
  console.log(city);
  phone = document.getElementById("phone").value;
  console.log(phone);
  
  address = document.getElementById("address").value;
  console.log(address);
  
  code = document.getElementById("code").value;
  console.log(code);
  
  email = document.getElementById("email").value;
  console.log(email);
  
  stripe = document.getElementById("stripe").value;
  cod = document.getElementById("cod").value;
  // let cod = document.getElementById("cod").value;
  console.log(stripe);
  
  item_count1 = document.getElementById("item-count");

  // Retrieve and log the innerHTML of the element
  item_count1 = item_count1.innerHTML; 

  console.log("item_count",item_count1);
  
  grand_total1 = document.getElementById("grand-total");
  grand_total1 = grand_total1.innerHTML;
  console.log(grand_total1);

  console.log("values added");

  // Hardcoded values
  //  title = document.getElementById("title-item").value;
  // console.log(title);
  console.log("call started");

  // Proceed with Frappe call
  frappe.call({
    method: 'qetah_phase_1.events.proceed_checkout.poceed_to_checkout',
    args: {
        fullname: fullname,
        phone: phone,
        address: address,
        city: city,
        state: state,
        code: code,
        email: email,
        stripe: 0,   // Defaulted stripe to 0
        cod: cod,
        item_count1: item_count1,
        grand_total1: grand_total1,
        title:title,
      },
    callback(r) {
      console.log("Frappe response:", r.message);
      if (r.message == "Created") {
        // Perform any success action
      }
      document.getElementById("messages").innerHTML = r.message;

      // // Clear form fields after submission
      // document.getElementById("fullname").value = "";
      // document.getElementById("phone").value = "";
      // document.getElementById("address").value = "";
      // document.getElementById("city").value = "";
      // document.getElementById("state").value = "";
      // document.getElementById("code").value = "";
      // document.getElementById("email").value = "";
      // document.getElementById("stripe").value = "";
    }
  });

  // Clear cart data from localStorage
  localStorage.removeItem('cart');
}

</script>

<script>
function showOrderSummary(items) {
    let popupContent = '<h3>Your Selected Items:</h3><ul>';
    items.forEach(item => {
        popupContent += `<li>${item.title} - Quantity: ${item.qty} </li>`;
    });
    popupContent += '</ul>';

    // Display the popup (you can use any modal/popup library or HTML-based modal)
    let popup = document.createElement('div');
    popup.id = 'order-summary-popup';
    popup.innerHTML = popupContent;
    popup.style.position = 'fixed';
    popup.style.top = '50%';
    popup.style.left = '50%';
    popup.style.transform = 'translate(-50%, -50%)';
    popup.style.backgroundColor = 'white';
    popup.style.padding = '20px';
    popup.style.border = '1px solid black';
    document.body.appendChild(popup);
}

</script>  


 

  

  <script>
    // Function to display data from localStorage
    function displayData() {
      const data = JSON.parse(localStorage.getItem('shippingDetails'));

      // Log the retrieved data to the console
      console.log('Retrieved data from localStorage:', data);

      if (data) {
        const displayDiv = document.getElementById('displayData');
        displayDiv.innerHTML = `
        <div class="badge badge-secondary m-2">Office</div>
        <div class="grp">
        <h6 class="title">Full Name :</h6>
        <div class="subtitle" id="fullname">${data.firstname}${data.lastname}</div>
        </div>
        <div class="grp">
        <h6 class="title">Phone No :</h6>
        <div class="subtitle"id="phone">${data.phone}</div>
        </div>
        <div class="grp">
        <h6 class="address">Address :</h6>
        <div class="subtitle" id="address" >${data.address}.</div>
        </div>
        <div class="grp">
        <h6 class="title">E-mail :</h6>
        <p class="subtitle" id="email">${data.email}</p>
        </div>
        <div class="grp">
        <h6 class="title">State :</h6>
        <div class="subtitle" id="state">${data.state}</div>
        </div>
        <div class="grp">
        <h6 class="title">City :</h6>
        <div class="subtitle" id="city">${data.city}</div>
        </div>
        <div class="grp">
        <h6 class="title">Zip / Postal Code :</h6>
        <div class="subtitle" id="code">${data.postalcode}</div>
        </div>
      `;

        // Also fill the form fields with the data from localStorage
        document.getElementById("fullname").value = `${data.firstname} ${data.lastname}`;
        document.getElementById("email").value = data.email;
        document.getElementById("state").value = data.state;
        document.getElementById("city").value = data.city;
        document.getElementById("phone").value = data.phone;
        document.getElementById("address").value = data.address;
        document.getElementById("code").value = data.postalcode;
      } else {
        console.log('No data found in localStorage');
      }
    }
    document.addEventListener('DOMContentLoaded', function () {
      displayData();
    });
  </script>

  <!-- stripe-card -->
  <script>
    // Get all the card and radio input elements
    const cards = document.querySelectorAll('.inner-card');
    const radios = document.querySelectorAll('input[type="checkbox"], input[type="radio"]');

    // Add event listener to each card
    cards.forEach(card => {
      card.addEventListener('click', function (e) {
        // Remove focus and checked attributes from all cards and radios
        cards.forEach(c => c.classList.remove('focus'));
        radios.forEach(r => r.removeAttribute('checked'));
        // Add focus class to the clicked card
        this.classList.add('focus');
        
        // Get the associated radio input using the data attribute
        const radioId = this.getAttribute('data-radio-id');
        const radio = document.getElementById(radioId);
        
        // Set the checked attribute on the associated radio input
        if (radio) {
          radio.setAttribute('checked', 'checked');
        }
      });
    });
    function handleRadioChange(event) {
        const target = event.target;

        // Check if the target is a radio button or a parent div
        let radioId = '';

        if (target.type === 'radio') {
            // If clicked on a radio button, use its id
            radioId = target.id;
        } else {
            // If clicked on a parent div, get the data-radio-id
            const parentDiv = target.closest('.card.inner-card');
            radioId = parentDiv ? parentDiv.getAttribute('data-radio-id') : '';
        }

        // Uncheck all radio buttons
        document.querySelectorAll('input[type="radio"][name="pm"]').forEach(radio => {
            radio.checked = false;
        });

        // Check the selected radio button
        if (radioId) {
            const selectedRadio = document.querySelector(`input[type="radio"][id="${radioId}"]`);
            if (selectedRadio) {
                selectedRadio.checked = true;
            }
        }
    }

    // Attach event listeners to all radio buttons and their parent divs
    document.querySelectorAll('input[type="radio"][name="pm"]').forEach(radio => {
        radio.addEventListener('click', handleRadioChange);
    });

    document.querySelectorAll('.card.inner-card').forEach(div => {
        div.addEventListener('click', handleRadioChange);
    });


  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const cartContainer = document.querySelector('.checkout-items');
      let cartItems = JSON.parse(localStorage.getItem('cart')) || [];

      // Define delivery fee and discount
      const deliveryFee = 120; // Example delivery fee
      const deliveryDiscount = 90; // Example delivery discount

      // Function to calculate and update the grand total
      function calculateGrandTotal(subtotal) {
        const totalWithFee = subtotal + deliveryFee; // Add delivery fee
        const totalWithDiscount = totalWithFee - deliveryDiscount; // Subtract discount
        return totalWithDiscount; // Return the final grand total
      }

      // Render Cart Items and Update Subtotal
      function renderCartItems(items) {
        cartContainer.innerHTML = ''; // Clear the container before appending new items
        let subtotal = 0;
        let itemCount = items.length;

        items.forEach((item, index) => {
          const price = parseFloat(item.price.replace(/[^0-9.-]/g, '')); // Convert price string to a number
          subtotal += price;
          const itemHTML = `
                <div class="card card-webinar cart-product-card">
                    <div class="card-head">
                        <span>Package ${index + 1} of ${items.length}</span>
                        <p>Fulfilled by <b>QETAH</b></p>
                    </div>
                    <hr />



                    <div class="cart-card">
                        <div class="card-head">
                            <div class="cart-conent">
                                <img src="${item.image}" alt="${item.title}" class="image" id="product_title" />
                                <div class="card-desc">
                                    <p class="text-ellipsis text-ellipsis-2"> <span> ${item.title}</span></p>
                                    <p class="text-ellipsis text-ellipsis-2">${item.desc}</p>
                                    
                                   ${item.brand ? `<span>${item.brand}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="prices">
                                <p class="price" id="product_price" > ${item.price}</p>
                                ${item.discount ? `<span>${item.discount}</span>` : ''}
                                <div class="icon-group" id="title-item">
                                    <span class="wishlist delete-item" data-title=${item.title}">
                                    <i class="bx bx-trash"></i>
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="card-foot">
                            <div class="qty">
                                <span>Qty:</span>
                                <span>${items.length}</span>
                            </div>
  
                        <div id="item-list"></div>
                        </div>
                    </div>
                </div>
            `;
          cartContainer.innerHTML += itemHTML; // Append the item to the cart container
        });

        // Update the subtotal and item count
        document.getElementById('subtotal').textContent = subtotal.toFixed(2); // Display subtotal
        document.getElementById('item-count').textContent = itemCount; // Display item count

        // Calculate and display the grand total
        const grandTotal = calculateGrandTotal(subtotal);
        document.getElementById('grand-total').textContent = grandTotal.toFixed(2); // Display grand total

        // Update delivery fee and discount
        document.getElementById('delivery-fee').textContent = deliveryFee.toFixed(2);
        document.getElementById('delivery-discount').textContent = deliveryDiscount.toFixed(2);

        // Add event listeners to all delete buttons (trash icons)
        document.querySelectorAll('.delete-item').forEach((trashIcon, index) => {
          trashIcon.addEventListener('click', function () {
            deleteCartItem(index);  // Use index from forEach to delete item
          });
        });
      }

      // Function to delete an item from the cart
      function deleteCartItem(index) {
        cartItems.splice(index, 1); // Remove item from array using index
        localStorage.setItem('cart', JSON.stringify(cartItems)); // Save the updated cart to localStorage
        renderCartItems(cartItems); // Re-render the updated cart
      }

      // Call renderCartItems on page load
      renderCartItems(cartItems);

      // Promo code logic
      document.getElementById('apply-code').addEventListener('click', function () {
        const promoCode = document.getElementById('code').value;
        let subtotal = parseFloat(document.getElementById('subtotal').textContent);

        if (isNaN(subtotal)) {
          document.getElementById('messages').textContent = "Subtotal is invalid!";
          return;
        }

        if (promoCode === 'DISCOUNT10') {
          const discount = subtotal * 0.10;
          const newSubtotal = subtotal - discount;
          document.getElementById('subtotal').textContent = newSubtotal.toFixed(2);
          localStorage.setItem('subtotal', newSubtotal.toFixed(2));
          document.getElementById('messages').textContent = `Promo code applied! You saved Rs. ${discount.toFixed(2)}.`;

          // Update the grand total after applying the promo code
          const grandTotal = calculateGrandTotal(newSubtotal);
          document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
        } else {
          document.getElementById('messages').textContent = "Invalid promo code.";
        }
      });

      // Retrieve subtotal and item count from localStorage on page load
      const storedSubtotal = localStorage.getItem('subtotal') || '0.00';
      const itemCount = (JSON.parse(localStorage.getItem('cart')) || []).length;
      document.getElementById('subtotal').textContent = storedSubtotal;
      document.getElementById('item-count').textContent = itemCount;

      // Recalculate the grand total after page load
      const grandTotal = calculateGrandTotal(parseFloat(storedSubtotal));
      document.getElementById('grand-total').textContent = grandTotal.toFixed(2);
      
    });
  </script>
      <script>
        // Example items array
        const items = [
            { title: 'Item A', quantity: 2 },
            { title: 'Item B', quantity: 1 },
            { title: 'Item A', quantity: 3 },
            { title: 'Item C', quantity: 4 },
        ];

        // Create a map to store combined quantities by title
        const itemMap = {};

        // Loop through items and group them by title
        items.forEach(item => {
            if (itemMap[item.title]) {
                // If the item already exists, add the quantity
                itemMap[item.title] += item.quantity;
            } else {
                // If the item does not exist, add it to the map
                itemMap[item.title] = item.quantity;
            }
        });

        // Convert the map back to an array for easier rendering
        const groupedItems = Object.keys(itemMap).map(title => ({
            title: title,
            quantity: itemMap[title],
        }));

        // Display the items in the DOM
        const itemList = document.getElementById('item-list');
        groupedItems.forEach(item => {
            const itemDiv = document.createElement('div');
            itemDiv.classList.add('qty');
            itemDiv.innerHTML = `
                <span>Title: ${item.title}</span>
                <span>Qty: ${item.quantity}</span>
            `;
            itemList.appendChild(itemDiv);
        });
    </script>
  {% endblock %}