{% extends "templates/primary.html" %}

{% block title %} QETAH | Cart Items {% endblock %}

{% block content %}

<!-- Student Header -->
<div class="content-area" :class="{'shifted-content': isStatic}">
  <div class="container cart">
    <div class="row row-col-2">
      <div class="col">
        <div class="cart-product">
          <div class="card card-webinar">
            <div class="card-head select-items">
              <span>
                <label class="check check-secondary"><input type="checkbox" /> Select All (Items)</label>
              </span>
              <button class="btn btn-light btn-icon">
                <i class="bx bx-trash icon-pre delete-item"></i> Delete
              </button>
            </div>
          </div>

          <!-- <h1>Your Cart</h1> -->
          <div class="cart-container">
            <!-- Cart items will be dynamically inserted here -->
          </div>
        </div>

      </div>
      <div class="col">
        <div class="card card-summary">
          <div class="card-head">
            <div class="location">
              <span>Location</span>
            </div>
            <div class="container model-container" x-data="{ isOpen: false }"
              x-init="$watch('isOpen', value => { document.body.style.overflow = value ? 'hidden' : 'auto';})">
              <button class="btn btn-secondary btn-icon model-btn" x-on:click="isOpen = true"><i
                  class="bx bx-location-plus icon-pre"></i> Add Shipping Address </button>
              <div class="modal active" x-show="isOpen" x-transition style="display: none;">
                <div class="modal-dialog" @click.away="isOpen = false">
                  <div class="modal-content ">
                    <div class="modal-head">
                      <h3 class="modal-title">Add Shipping Details</h3>
                    </div>
                    <div class="modal-body">
                      <div class="form-field">
                        <label class="field-label">First Name</label>
                        <div class="field">
                          <input type="text" class="field-text" placeholder="Enter first name" id="firstname" />
                        </div>
                      </div>
                      <div class="form-field">
                        <label class="field-label">Last Name</label>
                        <div class="field">
                          <input type="text" class="field-text" placeholder="Enter last name" id="lastname" />
                        </div>
                      </div>
                      <div class="form-field">
                        <label class="field-label">Phone No</label>
                        <div class="field">
                          <input type="text" class="field-text" placeholder="Enter your phone number" id="phone" />
                        </div>
                      </div>
                      <div class="form-field">
                        <label class="field-label">Address</label>
                        <div class="field">
                          <input type="text" class="field-text" placeholder="Enter your Address" id="address" />
                        </div>
                      </div>
                      <div class="form-field">
                        <label class="field-label">Email</label>
                        <div class="field">
                          <input type="email" class="field-text" placeholder="Enter your email" id="email" />
                        </div>
                      </div>

                      <div class="form-field">
                        <label class="field-label">State</label>
                        <div class="field">
                          <input type="text" class="field-text" placeholder="Enter your state" id="state" />
                        </div>
                      </div>
                      <div class="form-field">
                        <label class="field-label">City</label>
                        <div class="field">
                          <input type="text" class="field-text" placeholder="Enter your City" id="city" />
                        </div>
                      </div>
                      <div class="form-field">
                        <label class="field-label">Zip / Postal code</label>
                        <div class="field">
                          <input type="text" class="field-text" placeholder="Enter your Code" id="postalcode" />
                        </div>
                      </div>
                    </div>
                    <div class="modal-foot">
                      <button class="btn" x-on:click="isOpen = false">Cancel</button>
                      <button class="btn btn-secondary" id="saveButton" onclick="savebutton()">Save</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>


            <script>
              function displayData() {
                const data = JSON.parse(localStorage.getItem('shippingDetails'));

                // Log the retrieved data to the console
                console.log('Retrieved data from localStorage:', data);

                if (data) {
                  const displayDiv = document.getElementById('displayData');
                  displayDiv.innerHTML = `
                <!-- Target div where the data will be displayed -->
                <div id="displayData"></div>
                <p class="badge badge-sm badge-secondary badge-pill badge-sm">Home</p>
                <p class="media-title">${data.firstname} ${data.lastname}</p>
                <p class="media-subtitle txt-sm fw-500">${data.phone}</p>

                <h6 class="text-ellipsis text-ellipsis-2 txt-sm">
                ${data.address}
                </h6>`;
                } else {
                  console.log('No data found in localStorage');
                }
              }

              // Call displayData function on page load
              document.addEventListener('DOMContentLoaded', function () {
                displayData();
              });
            </script>

            <div class="media">
              <div class="media-head">
                <i class="bx bxs-user"></i>
              </div>
              <div class="media-body">
                <!-- Target div where the data will be displayed -->
                <div id="displayData"></div>
                <!-- <p class="badge badge-sm badge-secondary badge-pill badge-sm">Home</p>
                <p class="media-title">Ammar Shahid</p>
                <p class="media-subtitle txt-sm fw-500">04165651763</p>
                <h6 class="text-ellipsis text-ellipsis-2 txt-sm">
                  <strong>Two Line Truncation</strong>text trancate loremThis component truncates text with an ellipsis
                  (...)
                  when it exceeds the width of its container, useful for displaying long text in a limited space.Lorem
                  ipsum dolor
                  sit amet, consectetur adipiscing elit. Quisque ut risus sit amet nisl suscipit condimentum.Lorem ipsum
                  dolor sit amet, consectetur adipiscing elit. Quisque ut risus sit amet nisl suscipit condimentum.
                </h6> -->
              </div>
              <div class="media-foot">
                <label class="check check-dark"> <input type="checkbox" required /></label>
              </div>
            </div>
          </div>
          <hr>
          <div class="card-body">
            <div class="card-summary">
              <div id="updateOffcanvas"></div>
              <h2>Order Summary</h2>
              <div class="summary-content">
                <p class="summary-name">Subtotal <span id="item-count">0</span></p>
                <span class="summary-value">$ <span id="subtotal"></span></span>
              </div>
              <!-- <div class="summary-content">
                <p class="summary-name">Subtotal (4 items)</p>
                <span class="summary-value">Rs. 3,139</span>
              </div> -->
              <div class="voucher">
                <div class="voucher-input-control">
                  <span class="field">
                    <input type="text" class="field-text" placeholder="Enter Voucher Code" />
                  </span>
                  <button type="button" class="btn btn-secondary">
                    Submit
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="card-foot">
            <a href="/checkout" style="text-decoration: none;">
              <button class="btn btn-secondary btn-sm btn-block">
                Proceed To Checkout
              </button>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container products">
    <h1>Just For You</h1>
    <!-- Slider main container -->
    <div class="swiper product-slider">
      <!-- Additional required wrapper -->
      <div class="swiper-wrapper">
        <!-- Slides -->
        {% for product in products %}

        {% for variation in product.variations %}
        <div class="swiper-slide">
          <div class="products">
            <div class="badge badge-primary badge-pill">{{ variation.title }}</div>
            <div class="card product-card">
              <a href="/product">
                <div class="card-head">
                  <img class="card-image"
                    src="https://d2v5dzhdg4zhx3.cloudfront.net/web-assets/images/storypages/primary/ProductShowcasesampleimages/JPEG/Product+Showcase-1.jpg">
                </div>
                <div class="card-body">
                  <div class="card-title">{{ variation.intro }}</div>
                  <div class="card-desc text-ellipsis text-ellipsis-2">
                    {{ variation.description }}
                  </div>
                  <div class="card-subtitle"><del>USD {{ variation.price }}</del></div>
                  <div class="card-title">USD {{ variation.discount }}</div>
                  <div class="card-rating">
                    <i class="bx bxs-star"></i>
                    <span>{{ product.rating_count }}</span> ({{ product.sold }} Sold)
                  </div>
                </div>
              </a>
              <div class="card-foot">
                <button class="btn btn-light btn-icon btn-pill"><i class="bx bx-cart icon-pre"></i> Buy Now</button>
                <button class="btn btn-light btn-icon btn-circle bx bx-heart"></button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
        {% endfor %}
      </div>
      <button class="slide-next btn btn-secondary btn-sm bx bx-right-arrow-alt"></button>
      <button class="slide-prev btn btn-secondary btn-sm bx bx-left-arrow-alt"></button>
    </div>
  </div>
  {% endblock %}
   {% block scripts %} 
  <script>
    function savebutton() {
      const phone = document.getElementById('phone').value;
      const address = document.getElementById('address').value;
      const email = document.getElementById('email').value;
      const state = document.getElementById('state').value;
      const city = document.getElementById('city').value;
      const postalcode = document.getElementById('postalcode').value;

      frappe.call({
        method: 'qetah_phase_1.events.cart.carts',
        args: {
          address: address,
          email: email,
          phone: phone,
          state: state,
          city: city,
          postalcode: postalcode,
        },
        callback(r) {
          // console.log(r.message)
          document.getElementById("messages").innerHTML = r.message;

          document.getElementById('phone').value = ""
          document.getElementById("email").value = ""
          document.getElementById('address').value = ""
          document.getElementById('state').value = ""
          document.getElementById('city').value = ""
          document.getElementById('postalcode').value = ""
        }
      });
    }
  </script>
  <!-- cart -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const offcanvas = document.getElementById('offcanvas-cart');
      const offcanvasBody = offcanvas.querySelector('.offcanvas-body-cart'); // Add this line to get the offcanvas body
      const badge = document.querySelector('.cart-badge'); // Update this selector if needed
      const deleteSelectedBtn = document.getElementById('del-cart');

      let wishlist = [];

      function updateOffcanvas() {
        // Clear the current items
        offcanvasBody.innerHTML = '';

        // Add each item in the wishlist to the offcanvas
        wishlist.forEach((item, index) => {
          const itemDiv = document.createElement('div');
          itemDiv.className = 'items d-flex';
          itemDiv.innerHTML = `
                <div class="check-item" >
                    <label class="check check-secondary">
                        <input type="checkbox" class="item-checkbox" data-index="`+ index + `" />
                    </label>
                </div>
                <img src="${item.image}" alt="${item.title}" class="offcanvas-image" />
                <div class="text">
                    <p class="offcanvas-title text-ellipsis">${item.title}</p>
                    <div class="text-ellipsis text-ellipsis-2" style="font-size: 13px;margin-top: -10px;color: #626161;}">${item.desc}</div>
                     <div class="quantity-counter">
                    <p class="price update-price" data-price-per-item="${item.price}">${item.price}</p> 
                            <div class="counter">
            <button class="btn btn-light btn-circle btn-circle-sm bx bx-minus counter-decrement"></button>
            <input class="counter-value value" type="number" value="1" min="0" />
            <button class="btn btn-light btn-circle btn-circle-sm bx bx-plus counter-increment"></button>
        </div> 
         </div>
                    
                </div>
            `;
          offcanvasBody.appendChild(itemDiv);
        });

        // Update badge number
        badge.textContent = wishlist.length;
      }

      function addToWishlist(product) {
        // Add the product to the wishlist array
        wishlist.push(product);
        // Update the offcanvas display
        updateOffcanvas();
      }

      document.querySelectorAll('.btn-cart').forEach(button => {
        button.addEventListener('click', (e) => {
          const productCard = e.target.closest('.product-card');
          if (!productCard) return;

          // Get product details from the card
          const product = {
            title: productCard.querySelector('.card-title').innerText,
            image: productCard.querySelector('.card-image').src,
            desc: productCard.querySelector('.card-desc').innerText,
            price: productCard.querySelector('.card-price').innerText,
          };

          // Add product to wishlist
          addToWishlist(product);
        });
      });

      deleteSelectedBtn.addEventListener('click', () => {
        const checkboxes = offcanvasBody.querySelectorAll('.item-checkbox');

        // Iterate backward to safely remove items
        for (let i = checkboxes.length - 1; i >= 0; i--) {
          const checkbox = checkboxes[i];
          if (checkbox.checked) {
            const index = parseInt(checkbox.getAttribute('data-index'), 10);
            wishlist.splice(index, 1);
            checkbox.closest('.items').remove();
          }
        }

        updateOffcanvas();
      });
    });
  </script>
  <script>
    document.getElementById('saveButton').addEventListener('click', function () {
      const firstname = document.getElementById('firstname').value;
      const lastname = document.getElementById('lastname').value;
      const phone = document.getElementById('phone').value;
      const address = document.getElementById('address').value;
      const email = document.getElementById('email').value;
      const state = document.getElementById('state').value;
      const city = document.getElementById('city').value;
      const postalcode = document.getElementById('postalcode').value;
      const shippingDetails = {
        firstname,
        lastname,
        phone,
        address,
        email,
        state,
        city,
        postalcode
      };

      localStorage.setItem('shippingDetails', JSON.stringify(shippingDetails));

      console.log('Data saved to localStorage:', shippingDetails);
      displayData();
    });

    document.addEventListener('DOMContentLoaded', function () {
      displayData();
    });
  </script>
  <!-- Cart Items  -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const cartContainer = document.querySelector('.cart-container');
      const subtotalElement = document.getElementById('subtotal');
      const itemCountElement = document.getElementById('item-count');
      const selectAllCheckbox = document.querySelector('.select-items input[type="checkbox"]');
      const deleteSelectedButton = document.querySelector('.select-items .btn');

      // Retrieve cart items from localStorage, ensuring it's an array
      let cartItems = JSON.parse(localStorage.getItem('cart')) || [];

      // Function to render cart items
      function renderCartItems(items) {
        let subtotal = 0;
        let itemCount = 0;

        // Clear the cart container
        cartContainer.innerHTML = '';

        items.forEach((item, index) => {
          // Convert price to a number
          const price = parseFloat(item.price.replace(/[^0-9.-]/g, ''));
          const itemTotal = price * (item.quantity || 1);
          subtotal += itemTotal;
          itemCount += item.quantity || 1; // Increase itemCount by item quantity

          // Create HTML for the cart item
          const itemHTML = `
          <div class="card card-webinar cart-product-card" data-index="`+ index + `">
              <div class="card-head">
                  <span>
                      <label class="check check-secondary">
                          <input type="checkbox" class="item-checkbox" data-title="${item.title}" />${item.title}
                      </label>
                  </span>
              </div>
              <hr />
              <div class="cart-card">
                  <div class="card-head">
                      <div class="cart-content">
                          <img src="${item.image}" alt="${item.title}" id="image" class="image" />
                          <div class="card-desc">
                              <p class="text-ellipsis text-ellipsis-2">${item.desc}</p>
                              ${item.brand ? `<span>${item.brand}</span>` : ''}

                          </div>
                      </div>
                  </div>
                  <div class="card-body">
                      <div class="prices">
                          <p class="price">${(itemTotal).toFixed(2)}</p>
                        ${item.discount ? `<span>${item.discount}</span>` : ''}
                          <div class="icon-group">
                              <span class="wishlist"><i class="bx bx-heart"></i></span>
                              <span class="wishlist delete-item" data-index="`+ index + `"><i class="bx bx-trash"></i></span>
                          </div>
                      </div>
                  </div>
                  <div class="card-foot">
                      <div class="quantity-counter">
                          <div class="counter">
                              <button class="btn btn-light btn-icon btn-circle btn-circle-sm bx bx-minus counter-decrement decrement" data-index="`+ index + `" data-field="addition"></button>
                              <input class="counter-value value" type="number" value="${item.quantity || 1}" min="1" data-index="` + index + `" />
                              <button class="btn btn-light btn-icon btn-circle btn-circle-sm bx bx-plus counter-increment increment" data-index="`+ index + `"></button>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
        `;

          // Append the generated HTML to the cart container
          cartContainer.innerHTML += itemHTML;
        });

        // Update the subtotal
        subtotalElement.textContent = `${subtotal.toFixed(2)}`;
        // Update the item count
        itemCountElement.textContent = itemCount;
      }

      // Call the function to render cart items initially
      renderCartItems(cartItems);

      // Add event listener for the quantity increment and decrement
      cartContainer.addEventListener('click', function (event) {
        const target = event.target;
        const index = target.getAttribute('data-index');

        if (index !== null && !isNaN(index)) {
          if (target.classList.contains('increment')) {
            updateQuantity(index, 1);
          } else if (target.classList.contains('decrement')) {
            updateQuantity(index, -1);
          } else if (target.classList.contains('delete-item')) {
            deleteCartItem(index);
          }
        }
      });

      // Function to update the quantity and price
      function updateQuantity(index, change) {
        const quantityInput = document.querySelector(`.counter-value[data-index="` + index + `"]`);
        if (quantityInput) {
          let quantity = parseInt(quantityInput.value) + change;
          quantity = Math.max(quantity, 1); // Ensure quantity is at least 1

          cartItems[index].quantity = quantity;
          localStorage.setItem('cart', JSON.stringify(cartItems));

          renderCartItems(cartItems); // Re-render cart items with updated quantity
        }
      }

      // Delete individual items
      cartContainer.addEventListener('click', function (event) {
        if (event.target.classList.contains('bx-trash')) {
          const index = event.target.closest('.delete-item').getAttribute('data-index');
          deleteCartItem(index);
        }
      });

      // Function to delete an item from the cart
      function deleteCartItem(index) {
        cartItems.splice(index, 1); // Remove item from array using index
        localStorage.setItem('cart', JSON.stringify(cartItems)); // Save the updated cart to localStorage
        renderCartItems(cartItems); // Re-render the updated cart
      }

      // Delete selected items
      deleteSelectedButton.addEventListener('click', function () {
        const selectedItems = document.querySelectorAll('.item-checkbox:checked');
        const selectedTitles = Array.from(selectedItems).map(checkbox => checkbox.getAttribute('data-title'));

        // Filter out the selected items from cartItems
        cartItems = cartItems.filter(item => !selectedTitles.includes(item.title));

        // Save the updated cart to localStorage
        localStorage.setItem('cart', JSON.stringify(cartItems));

        // Reload the cart after deletion
        renderCartItems(cartItems);
      });

      // Add event listener for 'Select All' functionality
      selectAllCheckbox.addEventListener('change', function () {
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        const isChecked = selectAllCheckbox.checked;

        itemCheckboxes.forEach(checkbox => {
          checkbox.checked = isChecked;
        });
      });

      // Add new items to the cart
      function addToCart(newItem) {
        cartItems = JSON.parse(localStorage.getItem('cart')) || [];

        cartItems.push(newItem);
        localStorage.setItem('cart', JSON.stringify(cartItems));
        renderCartItems(cartItems);
      }

      // Clear the cart before adding new items (use when necessary)
      function clearCart() {
        cartItems = [];
        localStorage.setItem('cart', JSON.stringify(cartItems));
        renderCartItems(cartItems);
      }
    });
  </script>

  {% endblock %}
  <!-- header-fixed